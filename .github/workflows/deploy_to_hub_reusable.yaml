name: Deploy to HuggingFace Hub (Reusable)

on:
  workflow_call:
    inputs:
      repo_name:
        description: 'HuggingFace repository name (kebab-case, e.g., layout-alignment)'
        required: true
        type: string
      dir_name:
        description: 'Source directory name (snake_case, e.g., layout_alignment)'
        required: true
        type: string
      workflow_display_name:
        description: 'Display name for the workflow (e.g., Alignment)'
        required: true
        type: string
    secrets:
      HF_TOKEN:
        required: true
      HF_USERNAME:
        required: true
      HF_EMAIL:
        required: true

jobs:
  push_to_hub:
    runs-on: ubuntu-latest

    env:
      REPO_NAME: ${{ inputs.repo_name }}
      DIR_NAME: ${{ inputs.dir_name }}
      SRC_DIR: ./github-repo
      DST_DIR: ./huggingface-repo

    steps:
      - name: Checkout GitHub repository
        uses: actions/checkout@v3
        with:
          path: ${{ env.SRC_DIR }}

      - name: Checkout Huggingface repository
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          git clone https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${REPO_NAME} ${DST_DIR}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7

      - name: Export requirements.txt
        run: |
          DST_ABS=$(realpath ${DST_DIR})
          cd ${SRC_DIR}
          uv export --package ${DIR_NAME} --no-dev --no-hashes --format requirements-txt > ${DST_ABS}/requirements.txt

      - name: Copy files to Huggingface repository
        env:
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_EMAIL: ${{ secrets.HF_EMAIL }}
          SCRIPTS_DIR: ${{ env.SRC_DIR }}/scripts
        run: |
          makefile_path=${SRC_DIR}/Makefile
          make -f ${makefile_path} deploy REPO_NAME=${REPO_NAME} DIR_NAME=${DIR_NAME}
